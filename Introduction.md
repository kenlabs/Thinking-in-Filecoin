## Filecoin介绍

* Filecoin是一个基于区块链机制的分布式存储网络。

* 简单来说，在Filecoin网络中，存储提供者为网络提供存储空间，然后通过周期生成加密证明（证明他们提供了指定的存储空间），从而获得Filecoin网络的通证奖励（单位为FIL）。

* 除此之外，Filecoin也维护一个共享的区块链账本，用来支持通证的转账交易。

* 重要的是，Filecoin并没有使用中本聪风格的工作量证明来维持区块链上共识，而是使用存储证明本身：共识协议中的矿工的出块能力与其提供的存储空间容量成比例。

* Filecoin区块链不仅维护通证交易和账户的账本，并且实现了一个虚拟机，一个复制状态机，在网络参与者之间执行各种加密合约和市场机制。这些合约包括存储订单：客户支付FIL货币给存储提供者，以交换存储客户要求的特定文件数据。

* 通过Filecoin 虚拟机的分布式实现，存储交易和其他记录在链上的合约机制将随着时间的推移自动处理，而不需要合约的原始各方（比如请求数据存储的客户端）的进一步交互。

``` 
taoshengshi解读：
这里主要强调Filecoin与以往区块链的不同。
Filecoin既有以比特币为代表的区块链的功能，又有激励存储的功能。Filecoin的虚拟机是其特色，不仅可以处理交易，也可以维护合约的自动执行。
```

## 关键概念

* **数据结构**是语义标记的数据成员的集合。
* **函数**不依赖外部状态的计算过程。	
* **组件**是可以独立实现的功能集合。根据使用语言和特定组件的不同，组件可能对应于单个软件模块、运行某个循环的线程或进程、基于磁盘的数据库或各种其他设计选择。例如，ChainSync就是一个组件，它可以被实现为运行单个指定循环的进程或线程，该循环等待网络消息，并通过记录和转发区块数据。
* **API**是向组件传递消息的接口。API也可以认为是协议呈现给客户端的视图，比如对矿工节点的Storage Provider组件的API发起请求，用于在存储市场中存储文件。
* **节点**是与协议交互的完整软件和硬件系统。一个节点可能运行几个组件，参与几个子系统，并在本地或通过网络公开API，这取决于节点的配置。术语**“完整节点”**指的是运行所有组件并支持规范规定所有API的系统。
* **子系统**是整个协议的概念划分，这种划分方法可以从协议角度来划分（例如存储市场或检索市场），也可以从功能角度来划分（虚拟机），但子系统不一定对应于任何特定的节点组件或软件组件。
* **Actor**是指包含在虚拟机子系统状态中的虚拟实体。协议中的Actor类似于智能合约的参与方。Actor承载FIL通证余额，可以通过虚拟机的操作与其他Actor交互。但Actor不一定对应于任何特定的节点或软件组件。

```
taoshengshi解读：
这里主要介绍Filecoin设计的层次结构。
Filecoin的系统设计采用了清晰的概念体系：程序等于数据结构+算法，算法由函数体现。程序完成特定的功能，功能集合定义为组件，组件对外暴露API并接收外部的消息。组件构成节点，节点根据配置完成子系统的功能。子系统是协议的概念划分。子系统中的参与实体是Actor。
```

## Filecoin虚拟机

Filecoin用户面对的大部分功能（比如，支付、存储市场、存力表等）是通过Filecoin虚拟机来管理的。

虚拟机管理的内容包括：

* Filecoin网络生成一系列区块，并确定哪条区块链是正确的。每个区块都包含一系列称为消息的状态转换，以及应用这些消息后当前全局状态的检查点。
* 这里的全局状态由一系列Actor组成，每个Actor都有自己的私有状态。
* Filecoin中的Actor等同于以太坊的智能合约。Actor本质上是Filecoin网络中的一个“对象”，具有私有状态和一组可用于与其交互的方法。每个Actor都有一个归属于它的Filecoin通证余额、一个状态指针、一个code CID（标识Actor的类型），以及一个nonce（跟踪该Actor发送的消息数量）。
* 有两种途径来调用Actor上的方法。
* 首先，要作为系统的外部参与者（也就是使用Filecoin的普通用户）调用一个方法，必须向网络发送一个签名消息，并向打包消息的矿工支付费用。消息上的签名必须与一个帐户相关联的密钥相匹配，并且具有足够的Filecoin通证以支付消息的执行费用。这里的费用相当于比特币和以太坊的交易费用， 并且交易费用与处理消息所完成的工作成比例（比特币按字节为消息定价，以太坊使用“gas”的概念。Filecoin也用gas的概念）。
* 其次，一个Actor可以在调用方法期间调用另一个Actor的方法。然而，这种情况唯一可能发生的时候是由于外部用户的消息调用了某些Actor（注意：用户调用的参与者可能调用另一个参与者，然后该参与者再调用另一个参与者，执行的深度可能会很多）。

```
taoshengshi解读：虚拟机在Filecoin网络中处于中心位置。其核心概念是消息对全局状态的修改，而全局状态是由Actor这样的智能体组成。这样消息对全局状态的修改就变成了消息对Actor状态的修改，也就是对于Actor自身方法的调用。
由于Filecoin与以往区块链的不同，所以引入了Actor这样的状态表示主体。
```

## 系统分解

* 系统解耦的工作原理：

  * Filecoin将功能解耦和模块化到松散连接的系统中。每个系统都添加了重要的功能，通常是为了实现一系列重要且紧密相关的目标。
  * 例如，区块链系统、文件存储系统、市场系统是分开的。
    * 区块链系统提供了区块、Tipset和链等数据结构，并提供了区块同步、区块传播、区块验证、链选择和链访问等功能。
    * 文件存储系统提供了文件、片段、片段准备和数据传输等功能。
    * 市场系统提供了订单、交易、市场可见性和交易结算的市场等功能。

* 为什么说系统解耦非常有用？

  * 实现边界：可以单独实现Filecoin的子系统。这对于实现多样性尤其有用：我们想要许多安全关键系统的实现，例如区块链，但对于许多可以解耦的系统，则不需要很多实现。
  * 运行时解耦：系统解耦使构建和运行Filecoin节点变得更容易，比如将系统隔离到单独的程序中，甚至是部署单独的物理计算机中。
  * 安全隔离：一些系统比其他系统要求更高的操作安全性。系统解耦允许实现满足安全性和功能需求。一个很好的例子就是将区块链处理从数据传输中分离出来。
  * 可伸缩性：系统和各种用例对不同的操作提出不同的性能需求。系统解耦使得部署更容易根据系统边界而进行扩展。

* Filecoin节点并不需要所有系统

  * Filecoin节点的部署场景可以多样化，不需要所有的系统。大多数系统只需要Filecoin节点的子集。
  * 例如，区块链系统只需要同步链、参与安全共识、存储挖矿和区块链验证。许多Filecoin节点不需要这个区块链，仅从它们信任的节点中获取最新的StateTree内容即可。
  * 注意：Filecoin没有使用“全节点”和“轻客户端”的术语，尽管这些术语在比特币和其他区块链网络中广泛使用。在Filecoin中，这些术语没有清晰的定义。最好根据节点的功能来定义节点，也就是说根据节点运行的系统定义节点。例如:
    * **验证节点**：运行区块链系统。可以同步和验证区块链。不能挖矿或出块。
    * **客户端节点**：运行区块链、市场和数据传输系统。可以同步和验证链。不能挖矿或出块。
    * **检索矿机节点**：运行市场系统和数据传输系统。不需要区块链。可以进行检索交易（检索提供程序端）。可以发送数据给客户，并为此获得报酬。
    * **存储矿工节点**：运行区块链、存储市场、存储挖矿系统。可以同步和验证区块链。可以进行存储交易（存储提供商方）。可以将存储的数据密封到扇区中。能获得存储共识算力。可以挖矿或出块。

* 系统之间的边界划分方法：我们如何确定哪些功能属于一个系统而不是属于另一个系统?

  * 在系统之间划分界限是把紧密相关的功能从不相关的功能中中分离出来的艺术。在某种意义上，我们尝试将紧密集成的组件保持在同一个系统中，并尽量远离其它不相关的组件。
    * 这有时很简单，边界自然地来自数据结构或功能。例如，我们可以直接观察到客户和矿工之间的deal协商与VM执行无关。
    * 这有时比较困难，需要进一步抽象，并理清、添加或删除抽象。例如，StoragePowerActor和StorageMarketActor之前是一个Actor。这导致了StorageDeal构造、StorageMarket、存储挖矿、扇区密封、PoSt 生成等功能之间的大量耦合。要解耦这两组相关功能，需要将一个Actor分解为两个Actor。

  ```
  “Good fences make good neighbors.” -Robert Frost（美国“桂冠诗人”，获得4次普利策奖。）
  参考：https://zhuanlan.zhihu.com/p/32270692
  这一段可以认为是Filecoin的架构设计。
  ```

* 系统内部子系统之间的划分方法

  * 系统本身可以分解成更小的子单元。这些有时被称为“子系统”，以避免与更大的一类系统混淆。子系统本身可能会进一步分解为子系统。这里的“系统”并不是严格强制的，因为这些划分更多地与协议和工程实现相关，而不是与提供给用户的能力相关。

* 系统实现

  * 系统需求：为了更容易地将功能解耦到系统中，Filecoin协议假定了一组所有系统都需要用到的功能。该功能可以通过多种方式实现，应该将此处的规范仅仅作为建议(SHOULD)。
  * 所有系统都要求:
    * 存储库:
      * 本地IpldStore。为小型数据结构提供的本地持久存储。系统需要一个初始化好的IpldStore，并希望在系统崩溃期间保持数据的持久化。
      * 用户配置。用户可编辑的配置项。用户应该可以很容易地访问、查看和编辑这些文件。
      * 本地安全密钥存储库（KeyStore）。用于生成和使用加密密钥的工具，必须对Filecoin节点保密。系统不应该直接访问密钥，而应该通过一个抽象层（即KeyStore）来访问，它提供了加密、解密、签名、SigVerify等功能。
    * 本地FileStore。为文件（大字节数组）提供的本地持久存储。系统需要一个初始化好的FileStore，在其中存储大文件。有些系统（如Markets）可能需要存储和删除大量小文件(1MB - 10GB)。其他系统（如Storage Mining）可能需要存储和删除大量大文件(1GB - 1TB)。
    * 网络。大多数系统需要访问网络，以便能够连接到Filecoin网络中的对应节点。系统需要一个初始化好的libp2p.Node。然后在libp2p.Node之上，可以实现自己的协议。
    * 时钟。有些系统需要访问当前的网络时间，有些系统对时间漂移的容错性较低。系统需要一个初始化好的系统时钟，并通过它来获得网络时间。有些系统（如区块链）需要很少的时钟漂移，并且需要安全时间。
  * 为此，我们使用FilecoinNode数据结构，它在初始化时被传递到所有系统中。

*  系统限制：系统必须遵守以下限制:

  * 随机崩溃。Filecoin节点随时可能崩溃。系统必须在崩溃时保持安全和一致。这主要是通过限制持久状态的使用来实现的：通过Ipld数据结构持久化这种状态，并通过使用初始化的函数来检查状态和纠正错误。
  * 隔离。系统必须通过定义良好的、隔离的接口进行通信。并不是必须在共享内存空间上构建关键功能。(注意：为了提高性能，可以使用共享内存抽象来支持IpldStore、FileStore和libp2p，但是系统本身所必须。) 隔离不仅仅是一个运维上的问题，它还极大地简化了协议，使其更容易理解、分析、调试和更改。
  * 没有直接访问主机操作系统文件系统或磁盘。系统不能直接访问磁盘——它们通过FileStore和IpldStore抽象来访问磁盘。这为最终用户提供了高度的可移植性和灵活性，方便他们替换本地存储。
  * 没有直接访问主机操作系统网络堆栈或TCP/IP。系统不能直接访问网络——它们通过libp2p库来访问。也不能有任何其他协议类型的网络访问。这为Filecoin节点提供了跨平台和跨网络协议的高度可移植性，使Filecoin节点（及其所有关键系统）可以在各种协议（如蓝牙、局域网等）下运行。

```
taoshengshi解读：
对系统分解，系统实现，系统限制概述很好。通过理解Filecoin最初的设计原理，可以方便地对系统进行扩展和定制。
```

